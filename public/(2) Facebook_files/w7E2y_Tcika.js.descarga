;/*FB_PKG_DELIM*/

__d("EBInMemoryTablesChangeDataSink",["MAWBridgeFireAndForget"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){a===void 0&&(a=!1);if(a)return;d("MAWBridgeFireAndForget").fireAndForget("backend","writeLSDBToPersistedEBTables",{changeSet:b})}g.putChangeSet=a}),98);
__d("EBSMHydrationUtils",["ClientConsistencyEventEmitter","CurrentUser","EBSMProperties","MAWEncryptedBackupsPersistedDB","MAWLSDBEncryption","Promise","QPLUserFlow","Random","WALoggerDeferred","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error loading data from EB State db to in memory ReStore"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Loaded data from EB State db to in memory ReStore"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error loading table "," from EB State db to in memory ReStore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Hydrated ",": "," rows"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Hydration not performed for "," because its not present in IDB"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] DB being upgrated during EBSM hydration. Not hydrating."]);n=function(){return a};return a}function o(a){var b=[];a=a;while(a!==0)b.push(a.hd),a=a.tl;return b}function p(a,c){var e=a.transaction(c,"readonly"),f=[],g=e.objectStore(c).openCursor();return new(h||(h=b("Promise")))(function(a,b){g.onsuccess=function(a){a=a.target.result;if(a){var b=a.key,e=a.value;e=d("MAWLSDBEncryption").decryptLSDBObj(e,c);e!=null&&e.isLeaf!==void 0&&(e.keys!==void 0&&Array.isArray(e.keys)&&e.keys.length>0&&!Array.isArray(e.keys[0])&&(e.keys=e.keys.filter(function(a){return a!=null&&typeof a==="object"&&!Array.isArray(a)}).map(function(a){return o(a)})));f.push({key:b,value:e});a["continue"]()}},g.onerror=function(a){return b(a)},e.oncomplete=function(){a(f)}})}function a(a){var e=new Map();if(d("MAWEncryptedBackupsPersistedDB").isDBBeingUpgraded()){void d("WALoggerDeferred").ERROR(n());c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_ERROR_IDB_UPGRADING");return(h||(h=b("Promise"))).reject()}return(h||(h=b("Promise"))).all(Array.from(c("EBSMProperties").persistedTables).map(function(b){if(!a.objectStoreNames.contains(b)){c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_TABLE_NOT_IN_IDB");void d("WALoggerDeferred").LOG(m(),b);return!0}var f=p(a,b),g=new Map();return f.then(function(a){a.map(function(a,b){g.set(a,b)});e.set(b,g);c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_DONE_ON_"+b.toUpperCase());void d("WALoggerDeferred").LOG(l(),b,g.size);return!0},function(){c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_FAILED_ON_"+b.toUpperCase());void d("WALoggerDeferred").LOG(k(),b);return!1})})).then(function(a){var f=!0;a.forEach(function(a){a||(f=!1)});if(f){c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_DONE_ON_ALL_TABLES_SUCCESSFULLY");void d("WALoggerDeferred").LOG(j());return(h||(h=b("Promise"))).resolve(e)}else{c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_FAILED_TO_LOAD_DATA_FROM_IDB");void d("WALoggerDeferred").LOG(i());return(h||(h=b("Promise"))).reject(e)}})}function e(a,b,e){e===void 0&&(e={});var f=d("Random").random();c("QPLUserFlow").start(c("qpl")._(521484724,"141"),{annotations:e,instanceKey:f});c("promiseDone")(a(b),function(){c("QPLUserFlow").endSuccess(c("qpl")._(521484724,"141"),{instanceKey:f});var a=c("CurrentUser").getAppID();switch(a){case 772021112871879..toString():c("ClientConsistencyEventEmitter").emit("hardRefresh","ls_forced_refresh");break;default:c("ClientConsistencyEventEmitter").emit("softRefresh","ls_forced_refresh")}})}g.getAllRowsByTableName=p;g.loadEBdataToEphemeralRestore=a;g.withQPLAndRefresh=e}),98);
__d("QPLMemoryUtils",["MemoryUtils","QPLUserFlow"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("MemoryUtils").getCurrentMemory();b=b.usedJSHeapSize;c("QPLUserFlow").addAnnotations(a,{"int":{usedJSHeapSizeStart:b}})}function b(a){var b=d("MemoryUtils").getCurrentMemory();b=b.usedJSHeapSize;c("QPLUserFlow").addAnnotations(a,{"int":{usedJSHeapSizeEnd:b}})}g.logMemoryForQPLStart=a;g.logMemoryForQPLEnd=b}),98);
__d("createReStoreWarmEBTablesPersistence",["CurrentMessengerUser","EBInMemoryTablesChangeDataSink","EBSMHydrationUtils","EBSMProperties","FBLogger","MAWEncryptedBackupsPersistedDB","MWEBUseLocalStorage","MWEncryptedBackupsFirstRestoreUpsellTime","MWEncryptedBackupsLocalStorageEntryEnum","MWTabNotifier","Promise","QPLMemoryUtils","QPLUserFlow","ReStorePersistence","WALoggerDeferred","asyncToGeneratorRuntime","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] DB corruption detected - deleting EBSM db"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] An error occured in EBSM hydration when loading EB data"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] An error occured in EBSM hydration: IDB is null"]);k=function(){return a};return a}e=d("CurrentMessengerUser").getIDorEIMU();var l=c("MWTabNotifier")==null?void 0:c("MWTabNotifier")("mwChat-"+e),m=c("gkx")("23665"),n=null,o=!1,p=!1;function q(a,b,c){return(a.has(b)?a:a.set(b,c())).get(b)}function a(a,e){var f=(h||(h=b("Promise"))).resolve(),g=new Map();function r(a){return q(g,a,function(){return new Map()})}var s=d("MWEncryptedBackupsFirstRestoreUpsellTime").getFirstRestoreUpsellTime();c("QPLUserFlow").start(c("qpl")._(521481876,"1407"),{annotations:{string:{ebSessionIdentifier:s}}});d("QPLMemoryUtils").logMemoryForQPLStart(c("qpl")._(521481876,"1407"));function t(){if(e==null){c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_IDB_NULL");c("QPLUserFlow").endFailure(c("qpl")._(521481876,"1407"),"Hydration failed.");void d("WALoggerDeferred").ERROR(k());d("QPLMemoryUtils").logMemoryForQPLEnd(c("qpl")._(521481876,"1407"));return(h||(h=b("Promise"))).reject()}var a=d("EBSMHydrationUtils").loadEBdataToEphemeralRestore(e);return a.then(function(a){a.forEach(function(a,b){var c=r(b);a.forEach(function(a,b){c.set(b.key,b.value)})}),d("QPLMemoryUtils").logMemoryForQPLEnd(c("qpl")._(521481876,"1407")),c("QPLUserFlow").endSuccess(c("qpl")._(521481876,"1407"))},function(){c("QPLUserFlow").addPoint(c("qpl")._(521481876,"1407"),"EBSM_HYDRATION_FAILED"),void d("WALoggerDeferred").ERROR(j()),c("QPLUserFlow").endFailure(c("qpl")._(521481876,"1407"),"Hydration failed.")})}n=t();l==null?void 0:l.onEventReceive("flushChangesV2",function(a){var b=a.changeSet,c=a.sentinelDeleted;b.forEach(function(a,b){var e=r(b);a.forEach(function(a,b){d("ReStorePersistence").isDeletedValue(a,c)?e["delete"](b):e.set(b,a)})})});return{flush:function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,c){b.size>0&&b.forEach(function(a,c){a.size===0&&b["delete"](c)}),b.size>0&&(yield d("EBInMemoryTablesChangeDataSink").putChangeSet(a,b),b.forEach(function(a,b){var c=r(b);a.forEach(function(a,b){d("ReStorePersistence").isDeletedValue(a,d("ReStorePersistence").sentinelDeleted)?c["delete"](b):c.set(b,a)})}),l==null?void 0:l.postMessage("flushChangesV2",{changeSet:b,fromVersion:"",sentinelDeleted:d("ReStorePersistence").sentinelDeleted,version:""}))});function e(a,b){return c.apply(this,arguments)}return e}(),get:function(a,c,d){var e=r(c);if(o)return e.get(d);return n==null?(h||(h=b("Promise"))).reject("rehydration is not complete"):n.then(function(){o=!0;return e.get(d)})},logError:function(a,b,e,f){if(e==="dbCorruption"){var g;e=d("MWEncryptedBackupsFirstRestoreUpsellTime").getFirstRestoreUpsellTime();void d("WALoggerDeferred").ERROR(i());c("FBLogger")("labyrinth_web").mustfix("Got unexpected undefined in ebsm, mode: %s, table: %s, id: %s, deletedInThisTxn: %s. Deleting EBSM db",b,a,(g=f==null?void 0:f.id)!=null?g:"",(g=f==null?void 0:f.deletedInThisTxn)!=null?g:"");var h=c("EBSMProperties").mandatoryTables.has(a)||!m;p||(p=!0,d("MWEBUseLocalStorage").mwEBCreateLocalStorageEntry(c("MWEncryptedBackupsLocalStorageEntryEnum").EBSM_CORRUPTION_WIPE,h?"full":"partial"));f={bool:{fullDeletion:h},string:{mode:b,restoreUpsellTime:e,tableName:a}};d("EBSMHydrationUtils").withQPLAndRefresh(function(a){if(h)return d("MAWEncryptedBackupsPersistedDB").deleteEBIDB();else return d("MAWEncryptedBackupsPersistedDB").clearEBSMTable(a)},a,f)}},queueCommitWork:void 0,runExclusively:function(a){return new(h||(h=b("Promise")))(function(c,d){f=f.then(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{c(yield a())}catch(a){d(a)}}))})},shouldApplySync:function(){return!1},shouldInline:function(a,b){return!1},shouldSync:function(){return!1},types:["ephemeral"],uniqueId:""}}g["default"]=a}),98);
__d("mwEBCheckIfEBKeysExistInDisk",["EBSMHydrationUtils","FBLogger","MAWCurrentUser","MAWIndexedDbMetadata","MWChatEncryptedBackupsQPLEvents","Promise","QPLUserFlow","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("gkx")("415");function a(a){return new(h||(h=b("Promise")))(function(b,e){if(!i||a==="true")return b(null);b=d("MAWCurrentUser").getID();var f=d("MAWIndexedDbMetadata").ebLSDBName(b);b=indexedDB.open(f);b.onerror=function(){c("FBLogger")("labyrinth_web").mustfix("[labyrinth_web] Failed to open DB: "+f);c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{has_eb_keys_on_disk:"failed_to_open_db"}});return e(null)};b.onsuccess=function(a){var b="secure_encrypted_backups_client_state";a=a.target.result;if(!a.objectStoreNames.contains(b)){c("FBLogger")("labyrinth_web").mustfix("[labyrinth_web] client state not present in IDB");c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{has_eb_keys_on_disk:"table_not_present"}});return e(null)}return d("EBSMHydrationUtils").getAllRowsByTableName(a,b).then(function(a){a=a.length>0;c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{has_eb_keys_on_disk:a.toString()}})},function(){c("FBLogger")("labyrinth_web").mustfix("[labyrinth_web] Failed to getAllRowsByTableName ");c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{has_eb_keys_on_disk:"get_rows_failed"}});return e(null)})}})}g["default"]=a}),98);